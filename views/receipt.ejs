<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garapin Cloud - Receipt</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <style>
        .receipt-card {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #FFD699 !important;
            border: none;
            border-radius: 15px;
            height: 100%;
        }
        .receipt-card .card-body {
            padding: 0.75rem !important;
            min-height: 144px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .receipt-card h3 {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .receipt-info {
            color: #000;
            margin-bottom: 0;
        }
        .receipt-info .label {
            font-weight: normal;
        }
        .receipt-info .value {
            font-weight: bold;
        }
        .receipt-info .d-flex {
            margin-bottom: 0.4rem !important;
        }
        .receipt-stats {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-top: auto;
        }
        .receipt-stats .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }
        .receipt-stats .stat-label {
            color: #fff;
            font-weight: normal;
        }
        .receipt-stats .stat-value {
            color: #fff;
            font-weight: normal;
            font-size: 1.5rem;
            min-width: 60px;
            text-align: right;
        }
        .date-range {
            color: #000;
            text-align: right;
            margin-bottom: 8px;
        }
        .status-text {
            color: #28a745;
        }
        .row.g-4 {
            --bs-gutter-y: 1rem !important;
        }
        .date-input-group .input-group-text {
            background-color: transparent !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        .date-input {
            background-color: transparent !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        .date-input::placeholder {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        .status-card {
            background-color: #011168 !important;
            color: white;
            border: none;
            border-radius: 15px;
            height: 100%;
        }
        .status-card .card-body {
            padding: 0.75rem !important;
            min-height: 144px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container-fluid" data-firebase-config='<%= JSON.stringify(firebaseConfig) %>'>
        <div class="row">
            <%- include('partials/sidebar', {currentPage: 'raku-ai-receipt'}) %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 bg-light">
                <%- include('partials/header', {pageTitle: 'Receipt'}) %>

                <!-- Receipt content -->
                <div class="row g-4">
                    <!-- Application Info Card -->
                    <div class="col-12 col-lg-6">
                        <div class="card status-card">
                            <div class="card-body p-3">
                                <h5 class="card-title mb-3" style="color: #ffffff; font-weight: normal;">Application Info</h5>
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: normal;">Application Name</span>
                                        <h3 class="mb-0" style="font-weight: normal; min-width: 60px; text-align: right; font-size: 1.2rem;" id="appName">-</h3>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: normal;">Application Type</span>
                                        <h3 class="mb-0" style="font-weight: normal; min-width: 60px; text-align: right; font-size: 1.2rem;" id="appType">-</h3>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: normal;">Platform</span>
                                        <h3 class="mb-0" style="font-weight: normal; min-width: 60px; text-align: right; font-size: 1.2rem;" id="platform">-</h3>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span style="font-weight: normal;">Status</span>
                                        <span class="badge bg-success text-white" id="status" style="font-size: 0.85rem; font-weight: normal;">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Statistics Card -->
                    <div class="col-12 col-lg-6">
                        <div class="card status-card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0" style="color: #ffffff; font-weight: normal;">Status</h5>
                                    <div class="input-group date-input-group" style="width: 286px;">
                                        <span class="input-group-text">
                                            <i class="bi bi-calendar-range"></i>
                                        </span>
                                        <input type="text" class="form-control date-input" 
                                            id="receiptDateRangePicker" 
                                            placeholder="Select date range" 
                                            readonly
                                            style="cursor: pointer; font-size: 0.85rem;"
                                            title="Click to select date range">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-auto">
                                    <div style="width: 100%;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span style="font-weight: normal;">Receipt Terkirim</span>
                                            <h3 class="mb-0" style="font-weight: normal; min-width: 60px; text-align: right;" id="receiptsSent">0</h3>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span style="font-weight: normal;">Cost</span>
                                            <h3 class="mb-0" style="font-weight: normal; min-width: 60px; text-align: right;" id="cost">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Documentation Section -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">API Documentation</h5>
                                <div class="api-docs mt-2">
                                    <pre class="bg-dark text-light p-3 rounded"><code>curl -X POST https://hermes.raku.id/receipt/send-receipt \
  -H "Accept: application/json" \
  -H "Authorization: Bearer {api-key}" \
  -H "destination_number: {phone number with Indonesia country code 62 e.g. 628123456789}" \
  -H "Content-Type: application/json" \
  -d '{
    "merchantName": "{nama merchant}",
    "alamat": "{alamat merchant}",
    "invoiceNumber": "{no invoice}",
    "total": {total transaksi},
    "invoicePDFfile": "{base64_encoded_pdf_content}"
  }'</code></pre>
                                </div>
                                <div class="mt-4">
                                    <h5 class="card-title">API Simulation</h5>
                                    <form id="apiSimulationForm" class="mt-3">
                                        <div class="mb-4">
                                            <h6 class="mb-3">Headers</h6>
                                            <div class="mb-3">
                                                <label class="form-label">Authorization Bearer</label>
                                                <input type="text" class="form-control" id="apiKey" placeholder="Enter API key">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Destination Number</label>
                                                <input type="text" class="form-control" id="phoneNumber" placeholder="Enter Phone Number with Indonesia country code 62. e.g. 628123456789 (not +62)">
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <h6 class="mb-3">Request Data</h6>
                                            <div class="mb-3">
                                                <label class="form-label">Merchant Name</label>
                                                <input type="text" class="form-control" id="merchantName" placeholder="Enter merchant name">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Alamat</label>
                                                <textarea class="form-control" id="alamat" rows="2" placeholder="Enter merchant address"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Invoice Number</label>
                                                <input type="text" class="form-control" id="invoiceNumber" placeholder="Enter invoice number">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Total</label>
                                                <input type="number" class="form-control" id="total" placeholder="Enter total transaction">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Invoice PDF File</label>
                                                <input type="file" class="form-control" id="invoicePDFfile" accept="application/pdf" onchange="convertToBase64(this)">
                                                <input type="hidden" id="invoicePDFbase64">
                                            </div>
                                        </div>

                                        <div class="d-flex align-items-center">
                                            <button type="submit" class="btn btn-primary" id="sendRequestBtn">Send Request</button>
                                            <div class="spinner-border spinner-border-sm text-primary ms-2 d-none" id="loadingSpinner" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="/js/controllers/headerController.js"></script>
    <script src="/js/controllers/receiptController.js"></script>
    
    <!-- Simple utility function for the API simulation form -->
    <script>
        // Function to convert file to base64
        function convertToBase64(fileInput) {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result.split(',')[1];
                    document.getElementById('invoicePDFbase64').value = base64String;
                };
                reader.readAsDataURL(file);
            }
        }

        // Function to toggle loading state
        function setLoading(isLoading) {
            const button = document.getElementById('sendRequestBtn');
            const spinner = document.getElementById('loadingSpinner');
            
            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('d-none');
            } else {
                button.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        document.getElementById('apiSimulationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            setLoading(true);
            
            const requestData = {
                merchantName: document.getElementById('merchantName').value,
                alamat: document.getElementById('alamat').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                total: document.getElementById('total').value,
                invoicePDFfile: document.getElementById('invoicePDFbase64').value
            };

            try {
                const response = await fetch('/receipt/send-receipt', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${document.getElementById('apiKey').value}`,
                        'destination_number': document.getElementById('phoneNumber').value
                    },
                    body: JSON.stringify(requestData)
                });

                let result;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // Handle non-JSON response
                    const text = await response.text();
                    result = {
                        error: 'Unexpected response format',
                        details: text.substring(0, 200) // Only show first 200 chars of error
                    };
                }

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Failed to send receipt');
                }

                // Show success message
                alert(result.message || 'Receipt sent successfully');
                
                // Clear form
                e.target.reset();
                document.getElementById('invoicePDFbase64').value = '';
                
            } catch (error) {
                alert('Error: ' + (error.message || 'Failed to send receipt. Please try again.'));
            } finally {
                // Hide loading state
                setLoading(false);
            }
        });
    </script>
</body>
</html> 