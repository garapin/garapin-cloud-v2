<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garapin Cloud - Base Images</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .tooltip-inner {
            background-color: #ffd700 !important;
            color: #000 !important;
            font-size: 0.75rem;
            padding: 4px 8px;
        }
        .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #ffd700 !important;
        }
        .version-badge {
            cursor: help;
        }
    </style>
    <%- include('partials/firebase-sdk') %>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const firebaseConfig = JSON.parse(document.querySelector('[data-firebase-config]').dataset.firebaseConfig);
            if (!firebase.apps?.length) {
                firebase.initializeApp(firebaseConfig);
            }

            // Get current user and token
            const user = firebase.auth().currentUser;
            if (!user) {
                // Wait for auth state to be ready
                firebase.auth().onAuthStateChanged(async function(user) {
                    if (user) {
                        const token = await user.getIdToken();
                        // Fetch the page with auth header
                        const response = await fetch(window.location.pathname, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (response.ok) {
                            const html = await response.text();
                            // Create a temporary container
                            const temp = document.createElement('div');
                            temp.innerHTML = html;
                            
                            // Only update the baseImagesContainer content
                            const newContent = temp.querySelector('#baseImagesContainer');
                            const currentContent = document.querySelector('#baseImagesContainer');
                            if (newContent && currentContent) {
                                currentContent.innerHTML = newContent.innerHTML;
                            }

                            // Initialize tooltips for the new content
                            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                                return new bootstrap.Tooltip(tooltipTriggerEl);
                            });
                        }
                    }
                });
            }
        });

        // Initialize tooltips after page load
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</head>
<body>
    <div class="container-fluid" data-firebase-config='<%= JSON.stringify(firebaseConfig) %>'>
        <div class="row">
            <%- include('partials/sidebar', {currentPage: 'base-images'}) %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 bg-light">
                <%- include('partials/header', {pageTitle: 'Base Images'}) %>

                <!-- Information Box -->
                <div class="alert mb-4" role="alert" style="background-color: #6C7DFF; color: rgba(255, 255, 255, 0.9); border: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                        <div>
                            A base image serves as the foundational layer for publishing applications. Once created, these images are universally accessible, allowing all users to use them as a standardized framework for deploying applications efficiently.
                        </div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="row mb-4">
                    <div class="col-12">
                        <input type="text" class="form-control" placeholder="Search base images..." id="searchBaseImages">
                    </div>
                </div>

                <!-- AI Image Builder Button -->
                <div class="row mb-4">
                    <div class="col-12">
                        <button class="btn" style="background-color: #6C7DFF; color: white;" data-bs-toggle="modal" data-bs-target="#aiBuilderModal">
                            <i class="bi bi-robot"></i>
                            AI Image Builder
                        </button>
                    </div>
                </div>

                <!-- Base Images Grid -->
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="baseImagesContainer">
                    <% if (baseImages && baseImages.length > 0) { %>
                        <% baseImages.forEach(image => { %>
                            <div class="col">
                                <div class="card h-100">
                                    <div class="card-body p-2">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex mb-1">
                                                <div class="flex-shrink-0" style="width: 80px;">
                                                    <% if (image.thumbnailURL) { %>
                                                        <img src="<%= image.thumbnailURL %>" alt="<%= image.base_image %>" 
                                                            class="img-fluid" style="height: 60px; width: 100%; object-fit: contain;">
                                                    <% } else { %>
                                                        <div class="d-flex align-items-center justify-content-center" 
                                                            style="height: 60px; width: 100%; background-color: #f8f9fa; border-radius: 8px;">
                                                            <span class="display-6 text-muted">
                                                                <%= image.base_image.charAt(0).toUpperCase() %>
                                                            </span>
                                                        </div>
                                                    <% } %>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <h5 class="card-title mb-1" style="font-size: 1rem;">
                                                        <%= image.base_image %>
                                                    </h5>
                                                    <div class="mb-1">
                                                        <span class="badge bg-primary version-badge" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="bottom" 
                                                            title="<%= image.version %>">
                                                            <i class="bi bi-tag-fill me-1"></i>
                                                            <%= image.version.includes(':') ? image.version.split(':')[1] : image.version %>
                                                            <i class="bi bi-info-circle-fill ms-1" style="font-size: 0.75rem;"></i>
                                                        </span>
                                                    </div>
                                                    <p class="card-text text-muted small mb-0" style="font-size: 0.8rem;">
                                                        <%= image.description %>
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2 mt-1">
                                                <% if (image.database_server) { %>
                                                    <span class="badge bg-info">
                                                        <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: -2px;">database</span>
                                                        <%= image.database_server %>
                                                    </span>
                                                <% } %>
                                            </div>
                                            <% 
                                                console.log('User:', user ? user.provider_uid : 'No user');
                                                console.log('Image user_id:', image.user_id);
                                                if (user && user.provider_uid === image.user_id) { 
                                            %>
                                                <div class="mt-2">
                                                    <button class="btn btn-sm" 
                                                        style="background-color: white; color: #6C7DFF; border: 1px solid #6C7DFF; transition: all 0.3s;"
                                                        onmouseover="this.style.backgroundColor='#6C7DFF'; this.style.color='white';"
                                                        onmouseout="this.style.backgroundColor='white'; this.style.color='#6C7DFF';"
                                                        onclick="redeployImage('<%= image.base_image %>')">
                                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                                        Redeploy
                                                    </button>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle me-2"></i>
                                No base images available at the moment.
                            </div>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="baseImageToast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- AI Builder Modal -->
    <div class="modal fade" id="aiBuilderModal" tabindex="-1" aria-labelledby="aiBuilderModalLabel" aria-hidden="true" 
        data-create-url="<%= createBaseImageAIURL %>">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiBuilderModalLabel">Build Base Image with AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="aiBuilderForm">
                        <!-- Base Image Name -->
                        <div class="mb-3">
                            <label for="baseImageName" class="form-label">Base Image Name</label>
                            <input type="text" class="form-control" id="baseImageName" required>
                            <div id="baseImageError" class="form-text" style="color: #dc3545; display: none;">
                                Image not found on Dockerhub.
                            </div>
                        </div>

                        <!-- Version -->
                        <div class="mb-3">
                            <label for="version" class="form-label">Version</label>
                            <input type="text" class="form-control" id="version">
                            <div class="form-text" style="font-size: 0.75rem; color: #198754;">
                                <i class="bi bi-info-circle me-1"></i>
                                Enter a version or leave blank for the latest. Check Docker Hub for available versions.
                            </div>
                        </div>
                        
                        <!-- Storage Size Slider -->
                        <div class="mb-3">
                            <label for="storageSize" class="form-label">Storage Size (GB)</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" class="form-range flex-grow-1" id="storageSize" 
                                    min="1" max="10" step="1" value="1">
                                <span id="storageSizeValue" class="badge bg-primary" style="width: 35px;">1</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="buildImage()">Build Image</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/controllers/headerController.js"></script>
    <script src="/js/controllers/baseImagesController.js"></script>
</body>
</html> 